@using Benefit.Domain.Models
@model ApplicationUser

@{
    ViewBag.Title = "Структура";
    Layout = "~/Areas/Cabinet/Views/Shared/_CabinetLayout.cshtml";
}

@section PartnerHead
{
    @Html.Partial("_PartnerHead", Model)
}
@section scripts{
    <script>
        var skip = 0;
        var loadPartnersUrl = '@Url.Action("GetPartnersByReferalIds", "Panel")';

        function loadPartners(level) {
            var partnerLevelIds = $("li.partner-level-" + level).map(function () { return $(this).attr("id"); }).get();
            var postData = { ids: partnerLevelIds };
            $.post(loadPartnersUrl + '?&level=' + parseInt(level + 1),
                postData,
                function (data) {
                    var keys = Object.keys(data);
                    $(keys).each(function (index, key) {
                        var li = $("#" + key);
                        if (data[key].length > 0) {
                            var currentRow = li.find("div.structure_table_row");
                            currentRow.find(".expand").addClass("expand_close");
                            currentRow.after(data[key]);
                        }
                        if (partnerLevelIds.length == (index + 1)) {
                            setTimeout(function () { loadPartners(level + 1); }, 2000);
                        }
                    });
                });
        }

        $(function () {
            loadPartners(0);
        });
    </script>
}
<div class="partner_main col-lg-9 col-md-9 col-sm-9 col-xs-9">
    <div class="structure_menu">
        <div class="structure_menu_mentor">
            <p class="mentor_title">Наставник</p>
            @{
                var referal = Model.Referal == null ? "Немає" : Model.Referal.FullName;
            }
            <a class="mentor_name" data-toggle="modal" data-target="#mentor_modal">@referal</a>
        </div>
        <div class="structure_menu_date">
            <p class="structure_menu_date_title">Період нарахувань структури:</p>
            <form>
                <select id="structre_month" class="structre_month">
                    <option>Січень</option>
                    <option>Лютий</option>
                    <option>Березень</option>
                    <option>Квітень</option>
                    <option>Травень</option>
                    <option>Червень</option>
                    <option>Липень</option>
                    <option>Серпень</option>
                    <option selected>Вересень</option>
                    <option>Жовтень</option>
                    <option>Листопад</option>
                    <option>Грудень</option>
                </select>
                <select id="structre_year" class="structre_year"></select>
            </form>
        </div>
        <div class="structure_search_wrap">
            <form>
                <label for="structure_search">Пошук по структурі</label>
                <input class="structure_search" id="structure_search" type="search" placeholder="Введіть ім’я партнера">
            </form>
        </div>
        <div class="registration_search_wrap">
            <p class="registration_search_title">Пошук по даті реєстрації</p>
            <div>
                <div class="calendar"></div>
                <input class="orders_search" type="text" onkeyup="this.value=this.value.replace(/[^\d\.]+/g,'')" placeholder="Оберіть дату">
                <button class="orders_search_btn"><i></i>Знайти</button>
            </div>
        </div>
    </div>
    <div class="structure_submenu clearfix">
        <form class="structure_submenu_filters">
            <fieldset>
                <input class="hidden" type="checkbox" id="showAllStructure" name="showAllStructure">
                <label class="label_for_check" for="showAllStructure">Показати всю структуру</label>

                <input class="hidden" type="checkbox" id="hasNoCard" name="hasNoCard">
                <label class="label_for_check" for="hasNoCard">Не мають бонусної картки</label>

            </fieldset>
            <label for="status_select" class="status_select_label">Статус:</label>
            <select id="status_select">
                <option>Всі </option>
            </select>
        </form>
        <div class="structure_registration">
            <a href="#">Зареєструвати нового партнера в свою структуру</a>
        </div>
    </div>

    <div class="structure_table_wrap">
        <ul class="clearfix structure_table">

            <li class="structure_table_head">
                <div class="structure_table_row">
                    <div class="expand"></div>
                    <div class="table_content">
                        <div class="structure_table_name"><span>ПІБ</span></div>
                        <div class="structure_table_status"><span>Статус</span></div>
                        <div class="structure_table_balls pointer"><span>Бали</span></div>
                        <div class="structure_table_bonuses pointer"><span>Доступні бонуси</span></div>
                        <div class="structure_table_register_date"><span>Дата реєстрації</span></div>
                        <div class="structure_table_register_location"><span>Населений пункт</span></div>
                        <div class="structure_table_register_email"><span>E-mail</span></div>
                        <div class="structure_table_register_phone"><span>Телефон</span></div>
                        <div class="structure_table_register_card_number"><span>Номер картки</span></div>
                        <div class="structure_table_register_ref_code"><span>Реферальний код</span></div>
                    </div>
                </div>
            </li>
            @Html.Partial("_PartnersPartial", new KeyValuePair<int, IEnumerable<ApplicationUser>>(0, Model.Partners))
        </ul>
    </div>
</div>