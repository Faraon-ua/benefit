@using Benefit.Common.Constants
@model Benefit.Web.Models.Admin.SellerViewModel

@{
    ViewBag.Title = "Постачальник " + Model.Seller.Name;
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}
@section styles{
    <link href="~/Content/css/address.css" rel="stylesheet" />
    <link href="~/Areas/Admin/assets/css/jquery-ui-1.10.3.full.min.css" rel="stylesheet" />
    <link href="~/Areas/Admin/assets/css/dropzone.css" rel="stylesheet" />
    <link href="~/Areas/Admin/assets/css/chosen.css" rel="stylesheet" />
    <link href="~/Content/css/autocomplete.css" rel="stylesheet" />
}
@section scripts{
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/Areas/Admin/assets/js/jquery.mask.min.js"></script>
    <script src="~/Scripts/ckeditor/ckeditor.js"></script>
    <script src="~/Areas/Admin/assets/js/jquery-ui-1.10.3.full.min.js"></script>
    <script src="~/Scripts/jquery.autocomplete.min.js"></script>
    <script src="~/Scripts/address.js"></script>
    <script src="~/Areas/Admin/assets/js/dropzone.min.js"></script>
    <script src="~/Areas/Admin/assets/js/chosen.jquery.min.js"></script>


    <script>
        var createPersonnelUrl = '@Url.Action("Create", "Personnel")';
        var createModeratorUrl = '@Url.Action("CreateModerator", "Personnel")';
        var getUserUrl = '@Url.Action("GetUserByExternalNumber", "Users")';

        function GenerateLicenseKey() {
            $("#Seller_TerminalPassword").val(guid());
        }

        function UpdateCurrenciesNumber() {
            var maxNumber = parseInt(GetMaxAttributeValue('.currency-id', 'data-number'));
            var href = $("#addNewCurrency").attr("href");
            href = href.replace(/[0-9]/g, "");
            href = href + (maxNumber + 1);
            $("#addNewCurrency").attr("href", href);
            $("#addNewCurrency").removeAttr('disabled');
        }

        function UpdateCategoriesNumber() {
            $("html, body").animate({ scrollTop: $(document).height() }, 500);
            var maxNumber = parseInt(GetMaxAttributeValue('.category-id', 'data-number'));
            var href = $("#addNewCategory").attr("href");
            href = href.replace(/[0-9]/g, "");
            href = href + (maxNumber + 1);
            $("#addNewCategory").attr("href", href);
            $(".chosen-select").chosen({
                search_contains: true,
                width: "550px"
            });
            $('#addNewCategory').removeAttr('disabled');
        }

        function UpdateShippingMethodsNumber() {
            var maxNumber = parseInt(GetMaxAttributeValue('.shipping-id', 'data-number'));
            var href = $("#addNewShippingMethod").attr("href");
            href = href.replace(/[0-9]/g, "");
            href = href + (maxNumber + 1);
            $("#addNewShippingMethod").attr("href", href);
            $("#addNewShippingMethod").removeAttr('disabled');
            SetRegionsAutocomplete();
        }

        $(function () {
            SetRegionsAutocomplete();

            $(".chosen-select").chosen({
                search_contains: true,
                width: "450px"
            });

            $("#add-business-level-index").click(function () {
//                var newIndexUrl = '@Url.Action("")';
//                $.get()
            });

            $("body").on("click", ".remove-personnel", function (e) {
                if (confirm('Ви впевненні?')) {
                    e.preventDefault();
                    var href = $(this).attr("href");
                    $.post(href, {}, function (data) {
                        $("#personell").html(data);
                    });
                }
            });

            $("body").on("click", "#create-personnel", function () {
                var model = {
                    Name: $("#PersonnelForm_Name").val(),
                    Phone: $("#PersonnelForm_Phone").val(),
                    CardNumber: $("#PersonnelForm_CardNumber").val(),
                    SellerId: '@Model.Seller.Id'
                };
                $.post(createPersonnelUrl, model, function (data) {
                    $("#personell").html(data);
                    $("#personnel_modal").modal("hide");
                    $("#PersonnelForm_Name").val("");
                    $("#PersonnelForm_Phone").val("");
                    $("#PersonnelForm_CardNumber").val("");
                });
            });

            $("body").on("focusout", "#ModeratorForm_ExternalNumber", function () {
                var externalNumber = $(this).val();
                $.get(getUserUrl + "?externalNumber=" + externalNumber, function (user) {
                    if (user == "") {
                        $("#create-moderator").attr("disabled", "disabled");
                        $("#ModeratorForm_Name").val("");
                        $("#ModeratorForm_Phone").val("");
                    } else {
                        $("#ModeratorForm_UserId").val(user.Id);
                        $("#ModeratorForm_Name").val(user.FullName);
                        $("#ModeratorForm_Phone").val(user.PhoneNumber);
                        $("#create-moderator").removeAttr("disabled");
                    }
                });
            });

            $("body").on("click", "#create-moderator", function () {
                var model = {
                    UserId: $("#ModeratorForm_UserId").val(),
                    Name: $("#ModeratorForm_Name").val(),
                    Phone: $("#ModeratorForm_Phone").val(),
                    RoleName: $("#ModeratorForm_Role").val(),
                    SellerId: '@Model.Seller.Id'
                };
                $.post(createModeratorUrl, model, function (data) {
                    $("#personell").html(data);
                    $("#moderator_modal").modal("hide");
                    $("#ModeratorForm_ExternalNumber").val("");
                    $("#ModeratorForm_UserId").val("");
                    $("#ModeratorForm_Name").val("");
                    $("#ModeratorForm_Phone").val("");
                });
            });

            $("body").on("change", "#categories input[type=checkbox]", function () {
                if (this.checked) {
                    $("#categories input[type=checkbox]").not(this).prop("disabled", true);
                } else {
                    $("#categories input[type=checkbox]").not(this).prop("disabled", false);
                }
            });

            $("#1CCommerceML").click(function () {
                $("#warning-message").text("Будь ласка зачекайте результатів імпорту, не клацайте нічого!");
                $.ajax({
                    type: "POST",
                    url: routePrefix + '/Admin/Sellers/OneCCommerceMLImport?id=@Model.Seller.Id',
                    success: function (result) {
                        flashMessage(result.message, false, true);
                    },
                    error: function (xhr) {
                        flashMessage(xhr.responseJSON, true, true);
                    }
                });
            });

            $('.mask-number').mask("#0.00", { reverse: true });
            $('.mask-int-number').mask("#");

            $("#Seller_TotalDiscount, #WebSiteReferaExternalId, #BenefitCardReferaExternalId, #OwnerExternalId").mask('#');

            CKEDITOR.replace('sellerDescription', {
                filebrowserImageUploadUrl: '/home/UploadImage'
            });

            $("#Seller_UserDiscount").focus(function () {
                if ($(this).val() == "" || $(this).val() == "0") {
                    var userDiscount;
                    var totalDiscount = parseInt($("#Seller_TotalDiscount").val());
                    if (totalDiscount <= 10) {
                        userDiscount = totalDiscount / 2;
                    } else {
                        userDiscount = 5 + totalDiscount - 10;
                    }
                    $(this).val(userDiscount);
                }
            });

            try {
                Dropzone.autoDiscover = false;
                var fileList = new Array;
                var i = 0;
                $(".dropzone").dropzone({
                    url: routePrefix + "/Admin/Sellers/SaveUploadedFile?type=SellerGallery&parentId=@Model.Seller.Id",
                    maxFilesize: 12, // MB
                    addRemoveLinks: true,
                    dictDefaultMessage:
                        '<span class="bigger-150 bolder"><i class="icon-caret-right red"></i> Drop files</span> to upload \
				    <span class="smaller-80 grey">(or click)</span> <br /> \
				    <i class="upload-icon icon-cloud-upload blue icon-3x"></i> \
                    <div class="dz-default dz-message"></div>',
                    dictResponseError: 'Error while uploading file!',

                    //change the previewTemplate to use Bootstrap progress bars
                    previewTemplate: "<div class=\"dz-preview dz-file-preview\">\n  <div class=\"dz-details\">\n    <div class=\"dz-filename\"><span data-dz-name></span></div>\n    <div class=\"dz-size\" data-dz-size></div>\n    <img data-dz-thumbnail />\n  </div>\n  <div class=\"progress progress-small progress-striped active\"><div class=\"progress-bar progress-bar-success\" data-dz-uploadprogress></div></div>\n  <div class=\"dz-success-mark\"><span></span></div>\n  <div class=\"dz-error-mark\"><span></span></div>\n  <div class=\"dz-error-message\"><span data-dz-errormessage></span></div>\n</div>",
                    maxFiles: 15,
                    parallelUploads: 5,
                    dictMaxFilesExceeded: "You can only upload upto 15 images",
                    dictRemoveFile: "Delete",
                    dictCancelUploadConfirmation: "Are you sure to cancel upload?",
                    accept: function (file, done) {
                        if ((file.type).toLowerCase() != "image/jpg" &&
                            (file.type).toLowerCase() != "image/gif" &&
                            (file.type).toLowerCase() != "image/jpeg" &&
                            (file.type).toLowerCase() != "image/png"
                        ) {
                            done("Invalid file");
                        } else {
                            done();
                        }
                    },
                    init: function () {
                        var thisDropzone = this;
                        $.get(routePrefix + "/Admin/Sellers/GetSellerGallery?id=@Model.Seller.Id", function (data) {
                            $.each(data, function (key, value) {
                                var mockFile = { name: value.ImageUrl, size: 100000 };
                                thisDropzone.options.addedfile.call(thisDropzone, mockFile);
                                thisDropzone.options.thumbnail.call(thisDropzone, mockFile, routePrefix + "/Images/SellerGallery/" + value.SellerId + "/" + value.ImageUrl);
                            });

                        });

                        this.on("success", function (file, serverFileName) {
                            fileList[i] = { "serverFileName": serverFileName, "fileName": file.name, "fileId": i };
                            console.log(fileList);
                            i++;

                        });
                        this.on("removedfile", function (file) {
                            var rmvFile = "";
                            for (f = 0; f < fileList.length; f++) {
                                if (fileList[f].fileName == file.name) {
                                    rmvFile = fileList[f].serverFileName.Message;
                                }
                            }
                            if (!rmvFile) {
                                rmvFile = file.name;
                            }
                            $.ajax({
                                url: routePrefix + "/Admin/Sellers/DeleteUploadedFile?fileName=" + rmvFile + "&parentId=@Model.Seller.Id" + "&type=SellerGallery",
                                type: "POST",
                            });
                        });
                    },
                });
            } catch (e) {
                alert('Dropzone.js does not support older browsers!');
            }
        });

    </script>
}
@using (Html.BeginForm("CreateOrUpdate", "Sellers", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()

    @Html.ValidationSummary()

    <div class="tabbable">
        <ul class="nav nav-tabs">
            @{
    var displayClass = User.IsInRole(DomainConstants.AdminRoleName) ? "" : "hidden";
    var activeClass = User.IsInRole(DomainConstants.AdminRoleName) ? "" : "active";
            }
            <li class="active @displayClass">
                <a href="#home" data-toggle="tab">
                    <i class="blue icon-info bigger-110"></i>
                    Основна інфо
                </a>
            </li>
            <li class="@displayClass">
                <a href="#paymentTypes" data-toggle="tab">
                    <i class="grey icon-money bigger-110"></i>
                    Види оплати
                </a>
            </li>
            <li class="@displayClass">
                <a href="#categories" data-toggle="tab">
                    <i class="grey icon-list bigger-110"></i>
                    Категорії
                </a>
            </li>
            <li class="@activeClass">
                <a href="#images" data-toggle="tab">
                    <i class="red icon-camera bigger-110"></i>
                    Зображення та опис
                </a>
            </li>
            <li>
                <a href="#security" data-toggle="tab">
                    <i class="red icon-lock bigger-110"></i>
                    Безпека та коефіцієнти
                </a>
            </li>
            <li>
                <a href="#terminal" data-toggle="tab">
                    <i class="grey icon-tablet bigger-110"></i>
                    Термінал
                </a>
            </li>
            <li>
                <a href="#addresses" data-toggle="tab">
                    <i class="green icon-home bigger-110"></i>
                    Адреси
                </a>
            </li>
            <li>
                <a href="#shipping" data-toggle="tab">
                    <i class="orange icon-fighter-jet bigger-110"></i>
                    Доставка
                </a>
            </li>
            <li>
                <a href="#schedule" data-toggle="tab">
                    <i class="purple icon-calendar bigger-110"></i>
                    Графік роботи
                </a>
            </li>
            <li>
                <a href="#currency" data-toggle="tab">
                    <i class="blue icon-money bigger-110"></i>
                    Курси валют
                </a>
            </li>
            <li>
                <a href="#personell" data-toggle="tab">
                    <i class="pink icon-group bigger-110"></i>
                    Персонал
                </a>
            </li>
            <li>
                <a href="#import" data-toggle="tab">
                    <i class="pink icon-download-alt bigger-110"></i>
                    Імпорт
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane in active @displayClass" id="home">
                @Html.Partial("_SellerForm")
            </div>
            <div class="tab-pane" id="terminal">
                @Html.Partial("_TerminalForm")
            </div> 
            <div class="tab-pane" id="security">
                @Html.Partial("_Security", Model)
            </div>
            <div class="tab-pane @displayClass" id="paymentTypes">
                @Html.Partial("_PaymentTypes")
            </div>
            <div class="tab-pane @displayClass" id="categories">
                @Html.Partial("_Categories", Model.Seller)
            </div>
            <div class="tab-pane @activeClass" id="images">
                @Html.Partial("_Images", Model)
            </div>
            <div class="tab-pane" id="addresses">
                @Html.Partial("_Addresses", Model.Seller)
            </div>
            <div class="tab-pane" id="shipping">
                @Html.Partial("_ShippingMethods", Model.Seller)
            </div>
            <div class="tab-pane" id="schedule">
                @Html.Partial("_Schedules", Model.Seller.Schedules.ToList())
            </div>
            <div class="tab-pane" id="currency">
                @Html.Partial("_Currencies", Model.Seller)
            </div>
            <div class="tab-pane" id="import">
                @Html.Partial("_Import", Model.Seller)
            </div>
            <div class="tab-pane" id="personell">
                @Html.Partial("~/Areas/Admin/Views/Personnel/_PersonnelList.cshtml", Model.Seller.Personnels)
            </div>
        </div>
    </div>
    <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
            <button type="submit" class="btn btn-info">
                <i class="icon-ok bigger-110"></i>
                Зберегти
            </button>

            &nbsp; &nbsp; &nbsp;
            <a href="@Url.Action("Index", "Sellers")" class="btn">
                <i class="icon-undo bigger-110"></i>
                До пошуку
            </a>
        </div>
    </div>
}
@Html.Partial("~/Areas/Admin/Views/Personnel/_PersonnelForm.cshtml")
@Html.Partial("~/Areas/Admin/Views/Personnel/_ModeratorForm.cshtml")
